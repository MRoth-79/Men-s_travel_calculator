<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>מחשבון מימון לטיול גברים</title>
    <!-- טעינת Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- הגדרת פונט Inter -->
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #1f2937; /* Dark background */
        }
        .card {
            background-color: #ffffff;
        }
        /* סגנון עבור הטבלה */
        .history-table th, .history-table td {
            padding: 0.5rem;
            text-align: right;
            border-bottom: 1px solid #e5e7eb;
        }
        .history-table th {
            background-color: #f3f4f6;
            font-weight: 600;
        }
        .history-table tr:last-child td {
            border-bottom: none;
        }
    </style>
</head>
<body class="p-4 md:p-8 min-h-screen flex items-start justify-center">

    <div class="w-full max-w-lg card p-6 md:p-10 rounded-xl shadow-2xl my-8">
        <h1 class="text-3xl font-bold mb-6 text-center text-gray-800">מחשבון מימון לטיול גברים</h1>
        
        <!-- הגדרות קבועות מוצגות -->
        <div class="mb-6 bg-blue-50 p-4 rounded-lg border-l-4 border-blue-500">
            <h2 class="text-lg font-semibold text-blue-800 mb-2">נתונים קבועים</h2>
            <p class="text-sm text-gray-600">
                <span class="font-medium">תקציב קבוע:</span> 10,000 ש"ח
            </p>
            <p class="text-sm text-gray-600">
                <span class="font-medium">עלות למשתתף מלא:</span> 525 ש"ח
            </p>
            <p class="text-sm text-gray-600">
                <span class="font-medium">עלות למשתתף חלקי:</span> 325 ש"ח
            </p>
        </div>

        <!-- טופס קלט -->
        <div class="space-y-4">
            <!-- קלט משתתפים מלאים -->
            <div>
                <label for="numFull" class="block text-sm font-medium text-gray-700 mb-1">
                    מספר משתתפים מלאים (525 ש"ח לאדם)
                </label>
                <input type="number" id="numFull" value="0" min="0" 
                        class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500 text-lg text-center" 
                        oninput="calculateCost()">
            </div>

            <!-- קלט משתתפים חלקיים -->
            <div>
                <label for="numPartial" class="block text-sm font-medium text-gray-700 mb-1">
                    מספר משתתפים חלקיים (325 ש"ח לאדם)
                </label>
                <input type="number" id="numPartial" value="0" min="0" 
                        class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500 text-lg text-center" 
                        oninput="calculateCost()">
            </div>
        </div>

        <!-- כפתורי פעולה - שונה ל-grid-cols-1 -->
        <div class="grid grid-cols-1 gap-3 mt-6">
            
            <!-- כפתור שמירה -->
            <button onclick="saveCalculation()" 
                    class="w-full flex justify-center py-3 px-4 border border-transparent rounded-lg shadow-lg text-lg font-medium text-indigo-600 bg-white border-indigo-600 border hover:bg-indigo-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition duration-150 ease-in-out transform hover:scale-[1.01]">
                שמור חישוב
            </button>
        </div>
        
        <!-- אזור תוצאות -->
        <div class="mt-8 pt-6 border-t border-gray-200 space-y-4">
            <h2 class="text-xl font-bold text-gray-800">סיכום חישוב נוכחי</h2>

            <!-- סך המשתתפים -->
            <div class="flex justify-between p-3 bg-gray-50 rounded-lg">
                <span class="font-medium text-gray-600">סך המשתתפים:</span>
                <span id="totalPeopleOutput" class="font-bold text-gray-800">0</span>
            </div>

            <!-- עלות כוללת -->
            <div class="flex justify-between p-3 bg-gray-50 rounded-lg">
                <span class="font-medium text-gray-600">עלות כוללת לטיול:</span>
                <span id="totalCostOutput" class="font-bold text-gray-800">0 ש"ח</span>
            </div>

            <!-- עודף/חסר לתקציב -->
            <div class="flex justify-between p-3 rounded-lg" id="deficitBox">
                <span class="font-medium text-gray-600" id="deficitLabel">עודף/חסר לתקציב (חסר):</span>
                <span id="deficitOutput" class="font-bold text-red-600">0 ש"ח</span>
            </div>

            <!-- תוספת נדרשת לאדם -->
            <div class="p-4 rounded-lg shadow-md" id="contributionBox">
                <p class="text-center text-sm text-gray-600 mb-1">אם קיים חוסר, זהו הסכום שכל משתתף צריך להוסיף:</p>
                <div class="flex flex-col items-center">
                    <span class="text-3xl font-extrabold text-green-700" id="contributionPerPersonOutput">
                        0.00 ש"ח
                    </span>
                    <span class="text-xs text-gray-500 mt-1">(תוספת נדרשת למשתתף)</span>
                </div>
            </div>
        </div>

        <!-- הודעות שגיאה/מידע -->
        <div id="messageBox" class="mt-4 p-3 rounded-lg text-center text-sm hidden"></div>

        <!-- טבלת היסטוריית חישובים (חדש) -->
        <div class="mt-10 pt-6 border-t border-gray-200">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold text-gray-800">היסטוריית חישובים שנשמרו</h2>
                <button onclick="clearHistory()"
                        class="text-sm text-red-600 hover:text-red-800 font-medium transition duration-150">
                    נקה היסטוריה
                </button>
            </div>

            <!-- כפתור הורדת CSV חדש -->
            <button onclick="downloadHistoryTableAsCSV()"
                    class="w-full flex justify-center py-2 px-4 border border-transparent rounded-lg shadow-md text-sm font-medium text-white bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 transition duration-150 ease-in-out transform hover:scale-[1.01] mb-4">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 ml-2 rtl:mr-2" viewBox="0 0 20 20" fill="currentColor">
                    <path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L10 11.586l2.293-2.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" clip-rule="evenodd" />
                    <path fill-rule="evenodd" d="M10 2a1 1 0 011 1v7a1 1 0 11-2 0V3a1 1 0 011-1z" clip-rule="evenodd" />
                </svg>
                הורד היסטוריה כקובץ CSV
            </button>

            <div class="overflow-x-auto rounded-lg shadow-lg">
                <table class="w-full text-sm history-table border-collapse">
                    <thead>
                        <tr>
                            <th class="py-2 px-3 border-b-2 border-gray-300">תאריך/שעה</th>
                            <th class="py-2 px-3 border-b-2 border-gray-300">מלאים</th>
                            <th class="py-2 px-3 border-b-2 border-gray-300">חלקיים</th>
                            <th class="py-2 px-3 border-b-2 border-gray-300">סך עלות</th>
                            <th class="py-2 px-3 border-b-2 border-gray-300">עודף/חסר</th>
                            <th class="py-2 px-3 border-b-2 border-gray-300">תוספת לאדם</th>
                        </tr>
                    </thead>
                    <tbody id="historyTableBody" class="bg-white">
                        <!-- שורות החישוב ייטענו כאן -->
                    </tbody>
                </table>
            </div>

            <p id="noHistoryMessage" class="mt-4 text-center text-gray-500 text-sm hidden">
                אין חישובים שמורים עדיין.
            </p>
        </div>
    </div>

    <script>
        // *** הערה חשובה: לצורך פשטות ופונקציונליות מיידית באפליקציה פשוטה זו, הנתונים נשמרים באופן זמני ב-localStorage. ***
        // *** ליישום אחסון קבוע, מאובטח ומשותף (Multi-User), יש להשתמש ב-Firestore כנדרש. ***

        // הגדרות קבועות
        const FIXED_BUDGET = 10000;
        const COST_FULL = 525;
        const COST_PARTIAL = 325;

        // מערך גלובלי לאחסון היסטוריית החישובים
        let calculationHistory = [];

        /**
         * טוען את היסטוריית החישובים מ-localStorage.
         */
        function loadHistory() {
            try {
                const storedHistory = localStorage.getItem('tripFinanceHistory');
                if (storedHistory) {
                    calculationHistory = JSON.parse(storedHistory);
                }
            } catch (error) {
                console.error('Error loading history from localStorage:', error);
                // אם יש שגיאה בטעינה, מתחילים מערך ריק
                calculationHistory = []; 
            }
        }

        /**
         * שומר את היסטוריית החישובים ל-localStorage.
         */
        function saveHistory() {
            try {
                localStorage.setItem('tripFinanceHistory', JSON.stringify(calculationHistory));
            } catch (error) {
                console.error('Error saving history to localStorage:', error);
            }
        }
        
        /**
         * מעבד ומציג את טבלת היסטוריית החישובים.
         */
        function renderHistory() {
            const tableBody = document.getElementById('historyTableBody');
            const noHistoryMessage = document.getElementById('noHistoryMessage');
            tableBody.innerHTML = ''; // ניקוי הטבלה הקיימת

            if (calculationHistory.length === 0) {
                noHistoryMessage.classList.remove('hidden');
                return;
            }

            noHistoryMessage.classList.add('hidden');

            // רינדור השורות מהיסטוריה (החדש ביותר ראשון)
            [...calculationHistory].reverse().forEach(calc => {
                const row = tableBody.insertRow();
                row.className = 'hover:bg-gray-50';

                // פורמט תאריך ושעה
                const date = new Date(calc.timestamp);
                const formattedTime = date.toLocaleTimeString('he-IL', { hour: '2-digit', minute: '2-digit' });
                const formattedDate = date.toLocaleDateString('he-IL');
                
                // צביעה ועיצוב העודף/חסר
                let deficitText = calc.deficit < 0 
                    ? `עודף (${(calc.deficit * -1).toLocaleString('he-IL')} ש"ח)`
                    : calc.deficit > 0 
                    ? `חסר (${calc.deficit.toLocaleString('he-IL')} ש"ח)`
                    : 'מאוזן (0 ש"ח)';

                let deficitClass = calc.deficit < 0 ? 'text-blue-600 font-medium' : calc.deficit > 0 ? 'text-red-600 font-medium' : 'text-gray-600';

                // הוספת התאים
                row.innerHTML = `
                    <td class="py-2 px-3 whitespace-nowrap text-gray-500">
                        ${formattedDate}<br><span class="text-xs">${formattedTime}</span>
                    </td>
                    <td class="py-2 px-3 text-center">${calc.numFull}</td>
                    <td class="py-2 px-3 text-center">${calc.numPartial}</td>
                    <td class="py-2 px-3 font-semibold">${calc.totalCost.toLocaleString('he-IL')} ש"ח</td>
                    <td class="py-2 px-3 ${deficitClass}">${deficitText}</td>
                    <td class="py-2 px-3 text-center text-sm font-bold text-green-700">${calc.contributionPerPerson.toFixed(2).toLocaleString('he-IL')} ש"ח</td>
                `;
            });
        }

        /**
         * שומר את החישוב הנוכחי להיסטוריה.
         */
        function saveCalculation() {
            // ודא שהחישוב בוצע לפני השמירה
            const numFull = parseInt(document.getElementById('numFull').value) || 0;
            const numPartial = parseInt(document.getElementById('numPartial').value) || 0;
            const totalPeople = numFull + numPartial;

            if (totalPeople === 0) {
                const messageBox = document.getElementById('messageBox');
                messageBox.textContent = 'לא ניתן לשמור חישוב ללא משתתפים.';
                messageBox.className = 'mt-4 p-3 rounded-lg text-center text-sm bg-red-100 text-red-800';
                messageBox.classList.remove('hidden');
                return;
            }

            // קבלת הנתונים מהפלט הנוכחי (כדי למנוע חישוב כפול)
            const totalCost = (numFull * COST_FULL) + (numPartial * COST_PARTIAL);
            const deficit = totalCost - FIXED_BUDGET;
            const contributionPerPerson = deficit > 0 ? deficit / totalPeople : 0;
            
            const newCalculation = {
                timestamp: Date.now(),
                numFull: numFull,
                numPartial: numPartial,
                totalPeople: totalPeople,
                totalCost: totalCost,
                deficit: deficit, // חיובי=חסר, שלילי=עודף
                contributionPerPerson: contributionPerPerson
            };

            calculationHistory.push(newCalculation);
            saveHistory(); // שמירה ל-localStorage
            renderHistory(); // רינדור מחדש של הטבלה

            const messageBox = document.getElementById('messageBox');
            messageBox.textContent = 'החישוב נשמר בהצלחה בהיסטוריה.';
            messageBox.className = 'mt-4 p-3 rounded-lg text-center text-sm bg-green-100 text-green-800';
            messageBox.classList.remove('hidden');
        }

        /**
         * מנקה את היסטוריית החישובים (ללא אישור).
         */
        function clearHistory() {
            if (calculationHistory.length === 0) return;

            // מבצע מחיקה מיידית (נמנע משימוש ב-confirm() האסור)
            calculationHistory = [];
            saveHistory();
            renderHistory();
            
            const messageBox = document.getElementById('messageBox');
            messageBox.textContent = 'היסטוריית החישובים נוקתה בהצלחה.';
            messageBox.className = 'mt-4 p-3 rounded-lg text-center text-sm bg-orange-100 text-orange-800';
            messageBox.classList.remove('hidden');
        }


        // פונקציה לחישוב העלויות (ללא שינוי מהותי)
        function calculateCost() {
            // קבלת הקלטים
            const numFull = parseInt(document.getElementById('numFull').value) || 0;
            const numPartial = parseInt(document.getElementById('numPartial').value) || 0;

            // חישובים בסיסיים
            const totalPeople = numFull + numPartial;
            const totalCost = (numFull * COST_FULL) + (numPartial * COST_PARTIAL);
            const deficit = totalCost - FIXED_BUDGET;

            // אלמנטים של התוצאות
            const totalPeopleOutput = document.getElementById('totalPeopleOutput');
            const totalCostOutput = document.getElementById('totalCostOutput');
            const deficitOutput = document.getElementById('deficitOutput');
            const deficitLabel = document.getElementById('deficitLabel');
            const deficitBox = document.getElementById('deficitBox');
            const contributionPerPersonOutput = document.getElementById('contributionPerPersonOutput');
            const contributionBox = document.getElementById('contributionBox');
            const messageBox = document.getElementById('messageBox');

            // עדכון סך המשתתפים והעלות הכוללת
            totalPeopleOutput.textContent = totalPeople;
            totalCostOutput.textContent = totalCost.toLocaleString('he-IL') + ' ש"ח';
            
            // איפוס סגנון
            deficitBox.className = 'flex justify-between p-3 rounded-lg';
            contributionBox.className = 'p-4 rounded-lg shadow-md';
            messageBox.classList.add('hidden');
            
            let contributionPerPerson = 0;

            if (totalPeople === 0) {
                // מקרה: אין משתתפים
                deficitLabel.textContent = 'עודף/חסר לתקציב:';
                deficitOutput.textContent = '0 ש"ח';
                deficitOutput.className = 'font-bold text-gray-800';
                contributionPerPersonOutput.textContent = '0.00 ש"ח';
                contributionBox.classList.add('bg-gray-100');
                
                messageBox.textContent = 'הכנס מספר משתתפים כדי להתחיל בחישוב.';
                messageBox.className = 'mt-4 p-3 rounded-lg text-center text-sm bg-yellow-100 text-yellow-800';
                messageBox.classList.remove('hidden');
                
                return;
            }

            if (deficit > 0) {
                // מקרה: חסר כסף (Deficit)
                deficitLabel.textContent = 'חסר לתקציב:';
                deficitOutput.textContent = deficit.toLocaleString('he-IL') + ' ש"ח';
                deficitOutput.className = 'font-bold text-red-600';
                deficitBox.classList.add('bg-red-50');

                // חישוב התוספת לאדם
                contributionPerPerson = deficit / totalPeople;
                contributionPerPersonOutput.textContent = contributionPerPerson.toFixed(2).toLocaleString('he-IL') + ' ש"ח';
                contributionBox.classList.add('bg-green-100');
                
                messageBox.textContent = 'נדרשת תוספת של כסף מכל משתתף כדי לכסות את החוסר.';
                messageBox.className = 'mt-4 p-3 rounded-lg text-center text-sm bg-green-100 text-green-800';

            } else if (deficit < 0) {
                // מקרה: יש עודף כסף (Surplus)
                deficitLabel.textContent = 'עודף בתקציב:';
                // מציג את העודף כערך חיובי
                deficitOutput.textContent = (deficit * -1).toLocaleString('he-IL') + ' ש"ח'; 
                deficitOutput.className = 'font-bold text-blue-600';
                deficitBox.classList.add('bg-blue-50');
                
                contributionPerPersonOutput.textContent = '0.00 ש"ח';
                contributionBox.classList.add('bg-gray-100');
                
                messageBox.textContent = `יש לכם עודף של ${(deficit * -1).toLocaleString('he-IL')} ש"ח. אין צורך בתוספת.`;
                messageBox.className = 'mt-4 p-3 rounded-lg text-center text-sm bg-blue-100 text-blue-800';

            } else {
                // מקרה: בדיוק בכסף
                deficitLabel.textContent = 'עודף/חסר לתקציב:';
                deficitOutput.textContent = '0 ש"ח';
                deficitOutput.className = 'font-bold text-gray-800';
                deficitBox.classList.add('bg-yellow-50');
                contributionPerPersonOutput.textContent = '0.00 ש"ח';
                contributionBox.classList.add('bg-gray-100');
                
                messageBox.textContent = 'העלות הכוללת תואמת בדיוק לתקציב הקבוע! אין צורך בתוספת.';
                messageBox.className = 'mt-4 p-3 rounded-lg text-center text-sm bg-yellow-100 text-yellow-800';
            }
            
            // תמיד מציג את הודעת המידע
            messageBox.classList.remove('hidden');
        }

        /**
         * פונקציה להורדת נתוני ההיסטוריה כקובץ CSV.
         */
        function downloadHistoryTableAsCSV() {
            if (calculationHistory.length === 0) {
                const messageBox = document.getElementById('messageBox');
                messageBox.textContent = 'אין חישובים שמורים להורדה.';
                messageBox.className = 'mt-4 p-3 rounded-lg text-center text-sm bg-red-100 text-red-800';
                messageBox.classList.remove('hidden');
                return;
            }

            // 1. כותרות ה-CSV
            const headers = [
                "תאריך_ושעה",
                "משתתפים_מלאים",
                "משתתפים_חלקיים",
                "סך_משתתפים",
                "עלות_כוללת",
                "יתרה_לתקציב_(חיובי=חסר_שלילי=עודף)",
                "סטטוס",
                "תוספת_נדרשת_לאדם"
            ];
            
            // 2. בניית שורות הנתונים
            const csvRows = calculationHistory.map(calc => {
                const date = new Date(calc.timestamp);
                const dateTimeStr = date.toLocaleDateString('he-IL') + ' ' + date.toLocaleTimeString('he-IL');
                
                const status = calc.deficit > 0 ? "חסר" : calc.deficit < 0 ? "עודף" : "מאוזן";

                return [
                    `"${dateTimeStr}"`, // תאריך עם מרכאות כדי לשמור על הפורמט
                    calc.numFull,
                    calc.numPartial,
                    calc.totalPeople,
                    calc.totalCost,
                    calc.deficit, // הנתון הגולמי
                    status,
                    calc.contributionPerPerson.toFixed(2)
                ].join(','); // הפרדה באמצעות פסיקים
            });
            
            // 3. איחוד כותרות ושורות
            const csvString = [
                headers.join(','),
                ...csvRows
            ].join('\n'); // הפרדת שורות באמצעות ירידת שורה
            
            // 4. הפעלת ההורדה
            const blob = new Blob(["\uFEFF" + csvString], { type: 'text/csv;charset=utf-8;' }); // BOM for Hebrew/Excel compatibility
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = 'היסטוריית_חישוב_מימון.csv';
            
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            
            URL.revokeObjectURL(a.href);
            
            const messageBox = document.getElementById('messageBox');
            messageBox.textContent = 'היסטוריית החישובים הורדה בהצלחה כקובץ CSV.';
            messageBox.className = 'mt-4 p-3 rounded-lg text-center text-sm bg-blue-100 text-blue-800';
            messageBox.classList.remove('hidden');
        }


        // הפעלת הטעינה והחישוב הראשונית עם טעינת הדף
        window.onload = function() {
            loadHistory(); // טעינת היסטוריה מהשמירה
            renderHistory(); // הצגת הטבלה
            calculateCost(); // חישוב הפלט הנוכחי
        };

    </script>
</body>
</html>
